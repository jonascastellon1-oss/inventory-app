<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Inventory System</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600;700&family=Archivo:wght@700;800;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  darkMode: 'class',
  theme: { extend: { fontFamily: { sans: ['Outfit', 'system-ui'], mono: ['IBM Plex Mono', 'monospace'] } } }
};
</script>
<style>
* { -webkit-tap-highlight-color: transparent; }
html, body, #root { height: 100%; margin: 0; }
input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }
input[type=number] { -moz-appearance: textfield; }
@keyframes pulseGlow { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
.pulse-glow { animation: pulseGlow 1.5s ease-in-out infinite; }
.slide-up { animation: slideUp 0.25s ease-out; }
@keyframes slideUp { from { transform: translateY(12px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Theme variables */
:root {
  --bg-primary: #0a0a0a; --bg-secondary: #111111; --bg-card: #161616;
  --border: #2a2a2a; --text-primary: #f0f0f0; --text-secondary: #999999;
  --text-muted: #555555; --input-bg: #1c1c1c; --input-border: #333333;
  --nav-bg: #111111; --header-bg: #0a0a0a;
}
.light {
  --bg-primary: #f5f5f0; --bg-secondary: #eaeae5; --bg-card: #ffffff;
  --border: #d4d4cc; --text-primary: #1a1a1a; --text-secondary: #555555;
  --text-muted: #888888; --input-bg: #eaeae5; --input-border: #c4c4bc;
  --nav-bg: #f5f5f0; --header-bg: #f5f5f0;
}
body { background: var(--bg-primary); color: var(--text-primary); transition: background 0.2s, color 0.2s; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef, memo, useMemo } = React;

// ‚ïê‚ïê‚ïê ICONS ‚ïê‚ïê‚ïê
const Icon = ({d, size=20, className=""}) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor"
    strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{d}</svg>
);
const PackageIcon = (p) => <Icon {...p} d={<><path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></>} />;
const ClipboardIcon = (p) => <Icon {...p} d={<><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M9 14l2 2 4-4"/></>} />;
const WarehouseIcon = (p) => <Icon {...p} d={<><path d="M22 8.35V20a2 2 0 01-2 2H4a2 2 0 01-2-2V8.35A2 2 0 013.26 6.5l8-3.2a2 2 0 011.48 0l8 3.2A2 2 0 0122 8.35z"/><path d="M6 18h12M6 14h12"/></>} />;
const ArrowsIcon = (p) => <Icon {...p} d={<><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 014-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 01-4 4H3"/></>} />;
const ChartIcon = (p) => <Icon {...p} d={<><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></>} />;
const GearIcon = (p) => <Icon {...p} d={<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></>} />;
const AlertIcon = (p) => <Icon {...p} d={<><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />;
const CheckIcon = (p) => <Icon {...p} d={<><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
const XIcon = (p) => <Icon {...p} d={<><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></>} />;
const ClockIcon = (p) => <Icon {...p} d={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
const ScanIcon = (p) => <Icon {...p} d={<><path d="M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"/><line x1="7" y1="12" x2="17" y2="12"/></>} />;
const SearchIcon = (p) => <Icon {...p} d={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>} />;
const RefreshIcon = (p) => <Icon {...p} d={<><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></>} />;
const WifiIcon = (p) => <Icon {...p} d={<><path d="M5 12.55a11 11 0 0114.08 0M1.42 9a16 16 0 0121.16 0M8.53 16.11a6 6 0 016.95 0M12 20h.01"/></>} />;
const WifiOffIcon = (p) => <Icon {...p} d={<><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0119 12.55"/><path d="M5 12.55a10.94 10.94 0 015.17-2.39"/><path d="M10.71 5.05A16 16 0 0122.56 9"/><path d="M1.42 9a15.91 15.91 0 014.7-2.88"/><path d="M8.53 16.11a6 6 0 016.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>} />;
const MapPinIcon = (p) => <Icon {...p} d={<><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></>} />;
const TrashIcon = (p) => <Icon {...p} d={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></>} />;
const ChevronIcon = (p) => <Icon {...p} d={<polyline points="9 18 15 12 9 6"/>} />;
const LockIcon = (p) => <Icon {...p} d={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></>} />;
const UnlockIcon = (p) => <Icon {...p} d={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 019.9-1"/></>} />;
const SunIcon = (p) => <Icon {...p} d={<><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>} />;
const MoonIcon = (p) => <Icon {...p} d={<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>} />;
const UploadIcon = (p) => <Icon {...p} d={<><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0018 9h-1.26A8 8 0 103 16.3"/></>} />;

// ‚ïê‚ïê‚ïê LOCAL STORAGE ‚ïê‚ïê‚ïê
function lsGet(key) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : null; } catch { return null; } }
function lsSet(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }

// ‚ïê‚ïê‚ïê FIX #3: UUID-style transaction IDs ‚ïê‚ïê‚ïê
function genUUID(prefix) {
  const ts = Date.now().toString(36);
  const rand = Math.random().toString(36).substr(2, 6);
  return `${prefix}${ts}-${rand}`.toUpperCase();
}

function timeSince(d) { if(!d) return null; return (Date.now()-new Date(d).getTime())/3600000; }
function fmtDate(d) { if(!d) return "‚Äî"; const dt=new Date(d); return dt.toLocaleDateString("en-US",{month:"short",day:"numeric"})+" "+dt.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}); }
function prio(hrs) {
  if(hrs==null) return {label:"‚Äî",color:"text-slate-500",bg:"bg-slate-100 dark:bg-slate-800"};
  if(hrs>48) return {label:"URGENT",color:"text-red-600 dark:text-red-400",bg:"bg-red-50 border border-red-300 dark:bg-red-950 dark:border-red-700"};
  if(hrs>24) return {label:"HIGH",color:"text-amber-600 dark:text-amber-400",bg:"bg-amber-50 border border-amber-300 dark:bg-amber-950 dark:border-amber-700"};
  return {label:"NORMAL",color:"text-emerald-600 dark:text-emerald-400",bg:"bg-emerald-50 border border-emerald-300 dark:bg-emerald-950 dark:border-emerald-700"};
}

// ‚ïê‚ïê‚ïê FIX #1 & #4: OFFLINE QUEUE + DEAD LETTER ‚ïê‚ïê‚ïê
const QUEUE_KEY = "inv-pending-queue";
const DEAD_KEY = "inv-dead-letter";
const MAX_RETRIES = 5;

function getQueue() { return lsGet(QUEUE_KEY) || []; }
function setQueue(q) { lsSet(QUEUE_KEY, q); }
function getDeadLetter() { return lsGet(DEAD_KEY) || []; }
function setDeadLetter(d) { lsSet(DEAD_KEY, d); }

function pushQueue(item) {
  const q = getQueue();
  q.push({ ...item, _queuedAt: Date.now(), _retries: 0 });
  setQueue(q);
}

function moveToDead(item, error) {
  const d = getDeadLetter();
  d.push({ ...item, _failedAt: Date.now(), _error: error || "Max retries exceeded" });
  setDeadLetter(d);
}

// ‚ïê‚ïê‚ïê SHARED FETCH HELPER (OPT1: single POST path) ‚ïê‚ïê‚ïê
async function sendToGAS(url, form, data, apiKey) {
  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({ form, data, apiKey: apiKey || "" }),
  });
  const d = await r.json();
  if (!d.success) throw new Error(d.error || "Server rejected");
  return d;
}

// ‚ïê‚ïê‚ïê FORM DRAFT PERSISTENCE ‚ïê‚ïê‚ïê
const DRAFT_KEY = "inv-form-drafts";
function getDrafts() { return lsGet(DRAFT_KEY) || {}; }
function saveDraft(formName, data) {
  const d = getDrafts();
  d[formName] = { ...data, _savedAt: Date.now() };
  lsSet(DRAFT_KEY, d);
}
function clearDraft(formName) {
  const d = getDrafts();
  delete d[formName];
  lsSet(DRAFT_KEY, d);
}
function loadDraft(formName) {
  const d = getDrafts();
  return d[formName] || null;
}

// ‚ïê‚ïê‚ïê THEME HOOK ‚ïê‚ïê‚ïê
function useTheme() {
  const [dark, setDark] = useState(() => lsGet("inv-theme") !== "light");
  useEffect(() => {
    document.body.classList.toggle("dark", dark); document.body.classList.toggle("light", !dark);
    lsSet("inv-theme", dark ? "dark" : "light");
  }, [dark]);
  return { dark, toggle: () => setDark(d => !d) };
}

// ‚ïê‚ïê‚ïê ONLINE STATUS HOOK ‚ïê‚ïê‚ïê
function useOnline() {
  const [online, setOnline] = useState(navigator.onLine);
  useEffect(() => {
    const on = () => setOnline(true);
    const off = () => setOnline(false);
    window.addEventListener("online", on);
    window.addEventListener("offline", off);
    return () => { window.removeEventListener("online", on); window.removeEventListener("offline", off); };
  }, []);
  return online;
}

// ‚ïê‚ïê‚ïê REUSABLE INPUTS ‚ïê‚ïê‚ïê
function ScanInput({label,value,onChange,onSubmit,placeholder,IconEl,autoFocus,disabled,readOnly,scannerMode}) {
  const ref=useRef(null);
  const hk=e=>{if(e.key==="Enter"&&value?.trim()){e.preventDefault();onSubmit?.();}};
  useEffect(()=>{if(autoFocus&&ref.current)ref.current.focus();},[autoFocus]);
  return (<div className="mb-3">
    <label className="block text-xs font-bold uppercase tracking-wider mb-1" style={{color:"var(--text-muted)"}}>{label}</label>
    <div className="relative">
      <input ref={ref} type="text" value={value||""} onChange={e=>onChange(e.target.value)} onKeyDown={hk}
        placeholder={placeholder} disabled={disabled} readOnly={readOnly}
        inputMode={scannerMode ? "none" : undefined}
        className={`w-full py-3 px-4 pr-12 rounded-lg text-lg font-mono tracking-wide outline-none transition-all ${
          readOnly?"bg-emerald-50 dark:bg-slate-800 text-emerald-700 dark:text-emerald-400 border border-emerald-300 dark:border-slate-600":
          disabled?"opacity-50 border":
          "border-2 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"}`}
        style={!readOnly&&!disabled?{background:"var(--input-bg)",color:"var(--text-primary)",borderColor:"var(--input-border)"}:{}} />
      {IconEl&&<div className="absolute right-3 top-1/2 -translate-y-1/2" style={{color:"var(--text-muted)"}}><IconEl size={20}/></div>}
    </div>
  </div>);
}
function NumInput({label,value,onChange,max,min=0}) {
  return (<div className="mb-3">
    <label className="block text-xs font-bold uppercase tracking-wider mb-1" style={{color:"var(--text-muted)"}}>
      {label}{max!=null&&<span className="ml-2 opacity-60">(max: {max})</span>}
    </label>
    <input type="number" inputMode="numeric" value={value} onChange={e=>onChange(e.target.value)}
      min={min} max={max}
      className="w-full py-3 px-4 rounded-lg text-2xl font-bold text-center border-2 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 outline-none"
      style={{background:"var(--input-bg)",color:"var(--text-primary)",borderColor:"var(--input-border)"}} />
  </div>);
}

// ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê
function Toast({msg,type,onClose}) {
  useEffect(()=>{const t=setTimeout(onClose,3500);return()=>clearTimeout(t);},[onClose]);
  const c={success:"bg-emerald-600",error:"bg-red-600",info:"bg-orange-600",warning:"bg-amber-600"};
  return (<div className={`fixed top-4 left-4 right-4 z-50 ${c[type]||c.info} rounded-xl px-5 py-4 shadow-2xl flex items-center gap-3 slide-up text-white`}>
    {type==="success"?<CheckIcon size={24}/>:type==="error"?<XIcon size={24}/>:<AlertIcon size={24}/>}
    <span className="font-bold text-base flex-1">{msg}</span>
    <button onClick={onClose} className="text-white/70 hover:text-white text-xl font-bold">‚úï</button>
  </div>);
}

// ‚ïê‚ïê‚ïê SAMPLE DATA ‚ïê‚ïê‚ïê
function sampleBarcodes() {
  const now = Date.now();
  return [
    {barcodeId:"PLT-00001",seq:1,partNo:"QS41288YL",poNumber:"AF11424MISC",lotNo:"LOT-2026-001",status:"AWAITING",qaStatus:"",qtyReceived:0,location:"",receivedDate:null,stockedDate:null,currentQty:0},
    {barcodeId:"PLT-00002",seq:2,partNo:"963-00-701-04",poNumber:"AF11450SAF",lotNo:"LOT-2026-002",status:"AWAITING",qaStatus:"",qtyReceived:0,location:"",receivedDate:null,stockedDate:null,currentQty:0},
    {barcodeId:"PLT-00003",seq:3,partNo:"100540583",poNumber:"AF11398DELTA",lotNo:"LOT-2026-003",status:"RECEIVED",qaStatus:"PASS",qtyReceived:50,location:"",receivedDate:new Date(now-36*3600000).toISOString(),stockedDate:null,currentQty:50},
    {barcodeId:"PLT-00004",seq:4,partNo:"36408-C001",poNumber:"AF11402SAF",lotNo:"LOT-2026-004",status:"RECEIVED",qaStatus:"PASS",qtyReceived:200,location:"",receivedDate:new Date(now-52*3600000).toISOString(),stockedDate:null,currentQty:200},
    {barcodeId:"PLT-00005",seq:5,partNo:"CC-1025A",poNumber:"AF11390REC",lotNo:"LOT-2026-005",status:"IN STOCK",qaStatus:"PASS",qtyReceived:100,location:"RACK-A1-01",receivedDate:new Date(now-96*3600000).toISOString(),stockedDate:new Date(now-90*3600000).toISOString(),currentQty:75},
    {barcodeId:"PLT-00006",seq:6,partNo:"1077845-407AB07",poNumber:"AF11410SAF",lotNo:"LOT-2026-006",status:"IN STOCK",qaStatus:"PASS",qtyReceived:30,location:"RACK-B2-04",receivedDate:new Date(now-120*3600000).toISOString(),stockedDate:new Date(now-116*3600000).toISOString(),currentQty:30},
    {barcodeId:"PLT-00007",seq:7,partNo:"QS31263YL",poNumber:"AF11430MISC",lotNo:"LOT-2026-007",status:"RECEIVED",qaStatus:"HOLD",qtyReceived:80,location:"",receivedDate:new Date(now-8*3600000).toISOString(),stockedDate:null,currentQty:80},
    {barcodeId:"PLT-00008",seq:8,partNo:"963-00-702-20",poNumber:"AF11440SAF",lotNo:"LOT-2026-008",status:"DEPLETED",qaStatus:"PASS",qtyReceived:20,location:"BIN-C3-12",receivedDate:new Date(now-200*3600000).toISOString(),stockedDate:new Date(now-196*3600000).toISOString(),currentQty:0},
  ];
}
function sampleOrders() {
  return [
    {poNumber:"AF11424MISC",vendor:"Wollsdorf Leather",partNo:"QS41288YL",lotNo:"LOT-2026-001",qtyOrdered:100,qtyReceived:0,status:"AWAITING"},
    {poNumber:"AF11450SAF",vendor:"Safran Seats",partNo:"963-00-701-04",lotNo:"LOT-2026-002",qtyOrdered:50,qtyReceived:0,status:"AWAITING"},
    {poNumber:"AF11398DELTA",vendor:"Aerocovers",partNo:"100540583",lotNo:"LOT-2026-003",qtyOrdered:50,qtyReceived:50,status:"COMPLETE"},
    {poNumber:"AF11402SAF",vendor:"Safran Seats",partNo:"36408-C001",lotNo:"LOT-2026-004",qtyOrdered:200,qtyReceived:200,status:"COMPLETE"},
    {poNumber:"AF11390REC",vendor:"Manifattura Testori",partNo:"CC-1025A",lotNo:"LOT-2026-005",qtyOrdered:100,qtyReceived:100,status:"COMPLETE"},
  ];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DashboardView = memo(function DashboardView({txns,queue,awaiting,inStock,depleted,urgentCount,barcodes,admin,pendingCount}) {
  const kpis=[
    {label:"Awaiting Receipt",val:awaiting,color:"text-amber-600 dark:text-amber-400",bar:"bg-amber-500"},
    {label:"Need Stocking",val:queue.length,color:urgentCount>0?"text-red-600 dark:text-red-400":"text-orange-600 dark:text-orange-400",bar:urgentCount>0?"bg-red-500 pulse-glow":"bg-orange-500"},
    {label:"In Stock",val:inStock,color:"text-emerald-600 dark:text-emerald-400",bar:"bg-emerald-500"},
    {label:"Depleted",val:depleted,color:"text-slate-500 dark:text-slate-400",bar:"bg-slate-400 dark:bg-slate-600"},
  ];
  return (<div className="p-4 space-y-5">
    {pendingCount>0&&<div className="bg-amber-50 dark:bg-amber-950 border-2 border-amber-400 dark:border-amber-600 rounded-xl p-4 flex items-center gap-3">
      <UploadIcon size={24} className="text-amber-600 dark:text-amber-400 shrink-0"/>
      <div><p className="font-bold text-amber-700 dark:text-amber-300">{pendingCount} PENDING ‚Äî awaiting upload</p>
        <p className="text-amber-600 dark:text-amber-400 text-sm">Will auto-sync when online</p></div>
    </div>}
    {urgentCount>0&&<div className="bg-red-50 dark:bg-red-950 border-2 border-red-400 dark:border-red-600 rounded-xl p-4 flex items-center gap-3 pulse-glow">
      <AlertIcon size={28} className="text-red-600 dark:text-red-400 shrink-0"/>
      <div><p className="font-bold text-red-700 dark:text-red-300">{urgentCount} URGENT ‚Äî staging &gt;48h</p>
        <p className="text-red-600 dark:text-red-400 text-sm">Stockroom action required</p></div>
    </div>}
    {admin?<div className="grid grid-cols-2 gap-3">
      {kpis.map(k=>(<div key={k.label} className="rounded-xl p-4 border" style={{background:"var(--bg-card)",borderColor:"var(--border)"}}>
        <div className={`text-3xl font-bold font-mono ${k.color}`}>{k.val}</div>
        <div className="text-xs mt-1 font-medium uppercase tracking-wide" style={{color:"var(--text-muted)"}}>{k.label}</div>
        <div className={`h-1 ${k.bar} rounded-full mt-2`} style={{width:`${Math.min(100,k.val*5+10)}%`}}/>
      </div>))}
    </div>
    :<div className="rounded-xl p-4 border flex items-center gap-4" style={{background:"var(--bg-card)",borderColor:"var(--border)"}}>
      <div className={`text-4xl font-bold font-mono ${urgentCount>0?"text-red-600 dark:text-red-400":"text-orange-600 dark:text-orange-400"}`}>{queue.length}</div>
      <div><div className="text-sm font-bold" style={{color:"var(--text-primary)"}}>Items to Stock</div><div className="text-xs" style={{color:"var(--text-muted)"}}>Check queue below ‚Äî tap Stock tab to begin</div></div>
    </div>}
    {queue.length>0&&<div>
      <h2 className="text-sm font-bold uppercase tracking-wider mb-3 flex items-center gap-2" style={{color:"var(--text-secondary)"}}><ClockIcon size={14}/> Stocking Queue</h2>
      <div className="space-y-2">{queue.slice(0,10).map(q=>(<div key={q.barcodeId} className={`rounded-lg p-3 flex items-center gap-3 ${q.prio.bg}`}>
        <div className="flex-1 min-w-0">
          <div className="font-mono font-bold text-sm truncate" style={{color:"var(--text-primary)"}}>{q.barcodeId}</div>
          <div className="text-xs truncate" style={{color:"var(--text-muted)"}}>{q.partNo} ‚Ä¢ {q.poNumber}</div>
        </div>
        <div className="text-right shrink-0">
          <div className={`text-xs font-bold ${q.prio.color}`}>{q.prio.label}</div>
          <div className="text-xs" style={{color:"var(--text-muted)"}}>{q.hrsStaging!=null?q.hrsStaging.toFixed(1)+"h":"‚Äî"}</div>
        </div>
        <div className="text-xs font-mono" style={{color:"var(--text-muted)"}}>{q.qtyReceived||"‚Äî"}</div>
      </div>))}</div>
    </div>}
    <div>
      <h2 className="text-sm font-bold uppercase tracking-wider mb-3" style={{color:"var(--text-secondary)"}}>Recent Activity</h2>
      <div className="space-y-1.5">{txns.slice(-15).reverse().map(t=>(<div key={t.id} className="rounded-lg px-3 py-2 flex items-center gap-3 border" style={{background:"var(--bg-card)",borderColor:"var(--border)"}}>
        <div className={`w-2 h-2 rounded-full shrink-0 ${t.type==="IN"?"bg-emerald-500":t.type==="LOCATION"?"bg-orange-500":"bg-red-500"}`}/>
        <div className="flex-1 min-w-0">
          <span className="font-mono text-xs" style={{color:"var(--text-secondary)"}}>{t.barcode}</span>
          <span className="mx-1 opacity-30">‚Ä¢</span>
          <span className="text-xs" style={{color:"var(--text-muted)"}}>{t.type==="IN"?"Received":t.type==="LOCATION"?"Stocked":"Issued"} {Math.abs(t.qty)}</span>
        </div>
        <span className="text-[10px] shrink-0" style={{color:"var(--text-muted)"}}>{fmtDate(t.timestamp)}</span>
      </div>))}
      {txns.length===0&&<p className="text-center py-6 text-sm" style={{color:"var(--text-muted)"}}>No transactions yet ‚Äî try the Receive tab</p>}
      </div>
    </div>
  </div>);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECEIVING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ReceivingForm({barcodes,onSubmit,scannerMode}) {
  const draft = loadDraft("receiving");
  const [barcode,setBarcode]=useState(draft?.barcode||"");
  const [qty,setQty]=useState(draft?.qty||"");
  const [qa,setQa]=useState(draft?.qa||"");
  const [inspector,setInspector]=useState(draft?.inspector||"");
  const [notes,setNotes]=useState(draft?.notes||"");
  const [looked,setLooked]=useState(null);
  const [error,setError]=useState("");

  // Auto-save draft on field changes
  useEffect(()=>{
    if(barcode||qty||qa||inspector||notes) saveDraft("receiving",{barcode,qty,qa,inspector,notes});
  },[barcode,qty,qa,inspector,notes]);

  const lookup=useCallback(bc=>{
    const b=barcodes.find(x=>x.barcodeId===bc);
    if(!b){setError("QR Code not found");setLooked(null);return;}
    if(b.status!=="AWAITING"){setError(`Already ${b.status}`);setLooked(null);return;}
    setLooked(b);setError("");
  },[barcodes]);

  // QR deep link: auto-fill barcode from URL params (must be after lookup)
  useEffect(()=>{
    if(window._qrPrefill) {
      const pf = window._qrPrefill;
      setBarcode(pf.barcode);
      window._qrPrefill = null;
      setTimeout(()=>{ if(pf.barcode) lookup(pf.barcode); }, 200);
    }
  },[barcodes.length, lookup]);

  const scan=()=>{if(barcode.trim())lookup(barcode.trim());};
  const reset=()=>{setBarcode("");setQty("");setQa("");setInspector("");setNotes("");setLooked(null);setError("");clearDraft("receiving");};
  const ok=looked&&qty>0&&qa&&inspector;

  return (<div className="p-4">
    <div className="flex items-center gap-2 mb-4"><ClipboardIcon size={20} className="text-amber-500"/><h1 className="text-lg font-bold">Receiving Inspection</h1></div>
    <ScanInput label="Scan QR Code on Pallet" value={barcode} onChange={setBarcode} onSubmit={scan} placeholder="PLT-00001" autoFocus IconEl={ScanIcon} scannerMode={scannerMode}/>
    {error&&<div className="bg-red-50 dark:bg-red-950 border border-red-300 dark:border-red-700 rounded-lg p-3 mb-3 text-red-700 dark:text-red-300 text-sm font-bold">{error}</div>}
    {looked&&<div className="rounded-xl p-4 mb-4 slide-up border" style={{background:"var(--bg-card)",borderColor:"var(--border)"}}>
      <div className="grid grid-cols-2 gap-2">
        <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Part No</span><p className="font-mono font-bold text-emerald-600 dark:text-emerald-400">{looked.partNo}</p></div>
        <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>PO Number</span><p className="font-mono font-bold text-orange-600 dark:text-orange-400">{looked.poNumber}</p></div>
        <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Lot</span><p className="font-mono" style={{color:"var(--text-secondary)"}}>{looked.lotNo||"‚Äî"}</p></div>
        <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Status</span><p className="font-bold text-amber-600 dark:text-amber-400">{looked.status}</p></div>
      </div>
    </div>}
    {looked&&<>
      <NumInput label="Quantity Received" value={qty} onChange={setQty}/>
      <div className="mb-3">
        <label className="block text-xs font-bold uppercase tracking-wider mb-2" style={{color:"var(--text-muted)"}}>QA Status</label>
        <div className="grid grid-cols-3 gap-2">
          {[["PASS","bg-emerald-600 border-emerald-400"],["FAIL","bg-red-600 border-red-400"],["HOLD","bg-amber-600 border-amber-400"]].map(([s,ac])=>(
            <button key={s} onClick={()=>setQa(s)} className={`py-3 rounded-xl font-bold text-lg transition-all ${qa===s?`${ac} border-2 text-white shadow-lg scale-105`:"border text-slate-500"}`}
              style={qa!==s?{background:"var(--input-bg)",borderColor:"var(--input-border)"}:{}}>{s}</button>
          ))}
        </div>
      </div>
      <ScanInput label="Inspector Badge" value={inspector} onChange={setInspector} placeholder="Scan badge" IconEl={ScanIcon} scannerMode={scannerMode}/>
      <ScanInput label="Notes (optional)" value={notes} onChange={setNotes} placeholder="Comments..."/>
      <button onClick={()=>{if(ok){onSubmit({barcode:looked.barcodeId,partNo:looked.partNo,poNumber:looked.poNumber,lotNo:looked.lotNo,qty,qaStatus:qa,inspector,notes});reset();}}}
        disabled={!ok} className={`w-full py-4 rounded-xl font-bold text-xl tracking-wide transition-all mt-4 ${ok?"bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg active:scale-95":"opacity-50 cursor-not-allowed"}`}
        style={!ok?{background:"var(--input-bg)",color:"var(--text-muted)"}:{}}>
        SUBMIT RECEIVING
      </button>
    </>}
    {!looked&&<div className="text-center py-12" style={{color:"var(--text-muted)"}}><ScanIcon size={48} className="mx-auto mb-3 opacity-40"/><p className="text-sm">Scan the QR code on the pallet to begin</p></div>}
  </div>);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STOCKROOM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function StockroomForm({queue,onSubmit,scannerMode}) {
  const [sel,setSel]=useState(null);
  const draft = loadDraft("stockroom");
  const [loc,setLoc]=useState(draft?.loc||"");
  const [op,setOp]=useState(draft?.op||"");
  const [notes,setNotes]=useState(draft?.notes||"");
  useEffect(()=>{if(loc||op||notes) saveDraft("stockroom",{loc,op,notes});},[loc,op,notes]);
  const reset=()=>{setSel(null);setLoc("");setOp("");setNotes("");clearDraft("stockroom");};
  const ok=sel&&loc.trim()&&op.trim();

  return (<div className="p-4">
    <div className="flex items-center gap-2 mb-4"><WarehouseIcon size={20} className="text-orange-500"/><h1 className="text-lg font-bold">Stockroom Stocking</h1>
      {queue.length>0&&<span className="ml-auto bg-orange-600 text-white text-xs font-bold px-2 py-1 rounded-full">{queue.length}</span>}
    </div>
    {!sel?(<div>
      {queue.length===0?(<div className="text-center py-16"><CheckIcon size={48} className="mx-auto mb-3 text-emerald-500 opacity-50"/><p className="text-lg font-bold text-emerald-600 dark:text-emerald-400">Staging clear</p><p className="text-sm mt-1" style={{color:"var(--text-muted)"}}>Nothing to stock</p></div>)
      :(<div className="space-y-2"><p className="text-xs mb-2" style={{color:"var(--text-muted)"}}>Tap to begin stocking:</p>
        {queue.map(q=>(<button key={q.barcodeId} onClick={()=>setSel(q)} className={`w-full text-left rounded-xl p-4 transition-all active:scale-98 ${q.prio.bg}`}>
          <div className="flex items-center gap-3">
            <div className="flex-1"><div className="font-mono font-bold" style={{color:"var(--text-primary)"}}>{q.barcodeId}</div><div className="text-sm" style={{color:"var(--text-muted)"}}>{q.partNo} ‚Ä¢ PO: {q.poNumber}</div>
              <div className="text-xs" style={{color:"var(--text-muted)"}}>Qty: {q.qtyReceived||"‚Äî"} ‚Ä¢ QA: {q.qaStatus||"‚Äî"}</div></div>
            <div className="text-right"><div className={`text-sm font-bold ${q.prio.color}`}>{q.prio.label}</div><div className="text-xs" style={{color:"var(--text-muted)"}}>{q.hrsStaging?.toFixed(1)}h</div></div>
            <ChevronIcon size={20} style={{color:"var(--text-muted)"}}/>
          </div></button>))}
      </div>)}
    </div>):(<div className="slide-up">
      <button onClick={reset} className="text-orange-500 text-sm mb-3">‚Üê Back to queue</button>
      <div className="rounded-xl p-4 mb-4 border" style={{background:"var(--bg-card)",borderColor:"var(--border)"}}>
        <div className="grid grid-cols-2 gap-2">
          <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Barcode</span><p className="font-mono font-bold" style={{color:"var(--text-primary)"}}>{sel.barcodeId}</p></div>
          <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Part</span><p className="font-mono font-bold text-emerald-600 dark:text-emerald-400">{sel.partNo}</p></div>
          <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Qty</span><p className="font-bold" style={{color:"var(--text-primary)"}}>{sel.qtyReceived}</p></div>
          <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>QA</span><p className={`font-bold ${sel.qaStatus==="PASS"?"text-emerald-600 dark:text-emerald-400":sel.qaStatus==="HOLD"?"text-amber-600 dark:text-amber-400":"text-red-600 dark:text-red-400"}`}>{sel.qaStatus||"‚Äî"}</p></div>
        </div>
      </div>
      <ScanInput label="Scan Location" value={loc} onChange={setLoc} placeholder="RACK-A1-01" autoFocus IconEl={MapPinIcon} scannerMode={scannerMode}/>
      <ScanInput label="Operator Badge" value={op} onChange={setOp} placeholder="Scan badge" IconEl={ScanIcon} scannerMode={scannerMode}/>
      <ScanInput label="Notes (optional)" value={notes} onChange={setNotes} placeholder="Comments..."/>
      <button onClick={()=>{if(ok){onSubmit({barcode:sel.barcodeId,partNo:sel.partNo,location:loc.trim(),operator:op.trim(),notes});reset();}}}
        disabled={!ok} className={`w-full py-4 rounded-xl font-bold text-xl tracking-wide transition-all mt-4 ${ok?"bg-orange-600 hover:bg-orange-500 text-white shadow-lg active:scale-95":"opacity-50 cursor-not-allowed"}`}
        style={!ok?{background:"var(--input-bg)",color:"var(--text-muted)"}:{}}>
        STOCK THIS ITEM
      </button>
    </div>)}
  </div>);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ISSUING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function IssuingForm({barcodes,inventoryByPart,onSubmit,scannerMode}) {
  const [search,setSearch]=useState("");
  const [selPart,setSelPart]=useState(null);
  const [selBc,setSelBc]=useState(null);
  const draft = loadDraft("issuing");
  const [wo,setWo]=useState(draft?.wo||"");
  const [qty,setQty]=useState(draft?.qty||"");
  const [op,setOp]=useState(draft?.op||"");
  const [notes,setNotes]=useState(draft?.notes||"");
  useEffect(()=>{if(wo||qty||op||notes) saveDraft("issuing",{wo,qty,op,notes});},[wo,qty,op,notes]);

  const parts=Object.values(inventoryByPart).filter(p=>p.partNo.toLowerCase().includes(search.toLowerCase())&&p.totalQty>0);
  const fifo=selPart?selPart.barcodes.filter(b=>b.status==="IN STOCK"&&b.currentQty>0).sort((a,b)=>new Date(a.receivedDate||0)-new Date(b.receivedDate||0)):[];
  const maxQ=selBc?.currentQty||0;
  const ok=selBc&&wo.trim()&&qty>0&&qty<=maxQ&&op.trim();
  const reset=()=>{setSelPart(null);setSelBc(null);setWo("");setQty("");setOp("");setNotes("");clearDraft("issuing");};

  return (<div className="p-4">
    <div className="flex items-center gap-2 mb-4"><ArrowsIcon size={20} className="text-red-500"/><h1 className="text-lg font-bold">Production Issuing</h1></div>
    {!selPart?(<div>
      <div className="relative mb-3"><SearchIcon size={18} className="absolute left-3 top-1/2 -translate-y-1/2" style={{color:"var(--text-muted)"}}/>
        <input type="text" value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search part number..."
          className="w-full py-3 pl-10 pr-4 rounded-lg border-2 focus:border-orange-500 outline-none font-mono"
          style={{background:"var(--input-bg)",color:"var(--text-primary)",borderColor:"var(--input-border)"}}/></div>
      <div className="space-y-2">{parts.map(p=>(<button key={p.partNo} onClick={()=>setSelPart(p)}
        className="w-full text-left rounded-xl p-4 border active:border-orange-500 transition-all" style={{background:"var(--bg-card)",borderColor:"var(--border)"}}>
        <div className="flex items-center justify-between">
          <div><div className="font-mono font-bold" style={{color:"var(--text-primary)"}}>{p.partNo}</div><div className="text-xs" style={{color:"var(--text-muted)"}}>{p.barcodes.length} barcodes ‚Ä¢ {[...p.locations].join(", ")||"‚Äî"}</div></div>
          <div className="text-right"><div className="text-xl font-bold font-mono text-emerald-600 dark:text-emerald-400">{p.totalQty}</div><div className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Avail</div></div>
        </div></button>))}
        {parts.length===0&&<p className="text-center py-8 text-sm" style={{color:"var(--text-muted)"}}>{search?"No match":"Search for a part"}</p>}
      </div>
    </div>):!selBc?(<div className="slide-up">
      <button onClick={()=>setSelPart(null)} className="text-orange-500 text-sm mb-3">‚Üê Back</button>
      <div className="rounded-xl p-3 mb-3 border" style={{background:"var(--bg-card)",borderColor:"var(--border)"}}>
        <span className="font-mono font-bold" style={{color:"var(--text-primary)"}}>{selPart.partNo}</span><span className="text-emerald-600 dark:text-emerald-400 ml-2">({selPart.totalQty} avail)</span></div>
      <p className="text-xs mb-2" style={{color:"var(--text-muted)"}}>FIFO pick order (oldest first):</p>
      <div className="space-y-2">{fifo.map((b,i)=>(<button key={b.barcodeId} onClick={()=>setSelBc(b)}
        className={`w-full text-left rounded-xl p-4 transition-all active:scale-98 ${i===0?"bg-emerald-50 dark:bg-emerald-950 border-2 border-emerald-500":"border"}`}
        style={i!==0?{background:"var(--bg-card)",borderColor:"var(--border)"}:{}}>
        <div className="flex items-center gap-3">
          {i===0&&<span className="bg-emerald-600 text-white text-[10px] font-bold px-2 py-0.5 rounded">FIFO</span>}
          <div className="flex-1"><div className="font-mono font-bold" style={{color:"var(--text-primary)"}}>{b.barcodeId}</div><div className="text-xs" style={{color:"var(--text-muted)"}}>{b.location||"‚Äî"} ‚Ä¢ {fmtDate(b.receivedDate)}</div></div>
          <div className="text-xl font-bold font-mono text-emerald-600 dark:text-emerald-400">{b.currentQty}</div>
        </div></button>))}</div>
    </div>):(<div className="slide-up">
      <button onClick={()=>setSelBc(null)} className="text-orange-500 text-sm mb-3">‚Üê Back</button>
      <div className="rounded-xl p-4 mb-4 border" style={{background:"var(--bg-card)",borderColor:"var(--border)"}}>
        <div className="grid grid-cols-2 gap-2">
          <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Barcode</span><p className="font-mono font-bold" style={{color:"var(--text-primary)"}}>{selBc.barcodeId}</p></div>
          <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Part</span><p className="font-mono font-bold text-emerald-600 dark:text-emerald-400">{selBc.partNo}</p></div>
          <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Location</span><p className="font-bold text-orange-600 dark:text-orange-400">{selBc.location||"‚Äî"}</p></div>
          <div><span className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Available</span><p className="font-bold" style={{color:"var(--text-primary)"}}>{selBc.currentQty}</p></div>
        </div></div>
      <ScanInput label="Scan Work Order" value={wo} onChange={setWo} placeholder="WO-2026-00001" autoFocus IconEl={ScanIcon} scannerMode={scannerMode}/>
      <NumInput label="Quantity to Issue" value={qty} onChange={setQty} max={maxQ}/>
      <ScanInput label="Operator Badge" value={op} onChange={setOp} placeholder="Scan badge" IconEl={ScanIcon} scannerMode={scannerMode}/>
      <ScanInput label="Notes (optional)" value={notes} onChange={setNotes} placeholder="Comments..."/>
      <button onClick={()=>{if(ok){onSubmit({barcode:selBc.barcodeId,partNo:selBc.partNo,woNumber:wo.trim(),qty,operator:op.trim(),notes});reset();setSearch("");}}}
        disabled={!ok} className={`w-full py-4 rounded-xl font-bold text-xl tracking-wide transition-all mt-4 ${ok?"bg-red-600 hover:bg-red-500 text-white shadow-lg active:scale-95":"opacity-50 cursor-not-allowed"}`}
        style={!ok?{background:"var(--input-bg)",color:"var(--text-muted)"}:{}}>
        ISSUE MATERIAL
      </button>
    </div>)}
  </div>);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVENTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const InventoryView = memo(function InventoryView({inventoryByPart,barcodes}) {
  const [search,setSearch]=useState("");
  const [exp,setExp]=useState(null);
  const all=Object.values(inventoryByPart).filter(p=>p.partNo.toLowerCase().includes(search.toLowerCase()));
  return (<div className="p-4">
    <div className="flex items-center gap-2 mb-2"><PackageIcon size={20} className="text-orange-500"/><h1 className="text-lg font-bold">Inventory</h1>
      <span className="ml-auto text-xs" style={{color:"var(--text-muted)"}}>{all.length} parts ‚Ä¢ {all.reduce((s,p)=>s+p.totalQty,0)} qty</span></div>
    <div className="relative mb-3"><SearchIcon size={18} className="absolute left-3 top-1/2 -translate-y-1/2" style={{color:"var(--text-muted)"}}/>
      <input type="text" value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search..."
        className="w-full py-2.5 pl-10 pr-4 rounded-lg border focus:border-orange-500 outline-none font-mono text-sm"
        style={{background:"var(--input-bg)",color:"var(--text-primary)",borderColor:"var(--input-border)"}}/></div>
    <div className="space-y-1.5">{all.map(p=>(<div key={p.partNo}>
      <button onClick={()=>setExp(exp===p.partNo?null:p.partNo)} className="w-full text-left rounded-lg px-3 py-2.5 border active:border-orange-500" style={{background:"var(--bg-card)",borderColor:"var(--border)"}}>
        <div className="flex items-center justify-between"><div><span className="font-mono font-bold text-sm" style={{color:"var(--text-primary)"}}>{p.partNo}</span>
          <span className="text-xs ml-2" style={{color:"var(--text-muted)"}}>{[...p.locations].join(", ")}</span></div>
          <span className="font-mono font-bold text-emerald-600 dark:text-emerald-400">{p.totalQty}</span></div></button>
      {exp===p.partNo&&<div className="rounded-b-lg px-3 py-2 border-x border-b space-y-1 slide-up" style={{background:"var(--bg-secondary)",borderColor:"var(--border)"}}>
        {p.barcodes.map(b=>(<div key={b.barcodeId} className="flex items-center justify-between text-xs">
          <span className="font-mono" style={{color:"var(--text-secondary)"}}>{b.barcodeId}</span>
          <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${b.status==="IN STOCK"?"bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-400":b.status==="RECEIVED"?"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-400":"bg-slate-200 dark:bg-slate-700 text-slate-500"}`}>{b.status}</span>
          <span style={{color:"var(--text-muted)"}}>{b.location||"‚Äî"}</span>
          <span className="font-mono font-bold" style={{color:"var(--text-primary)"}}>{b.currentQty}</span>
        </div>))}</div>}
    </div>))}
    {all.length===0&&<p className="text-center py-8 text-sm" style={{color:"var(--text-muted)"}}>No inventory</p>}
    </div>
  </div>);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function SettingsView({config,setConfig,onSync,syncing,setToast,setBarcodes,setOrders,setTxns,orders,barcodes,admin,dark,toggleTheme,scannerMode,setScannerMode,pendingCount,postToSheet}) {
  const [url,setUrl]=useState(config.appsScriptUrl||"");
  const [apiKey,setApiKey]=useState(config.apiKey||"");
  const [testing,setTesting]=useState(false);
  const [showOo,setShowOo]=useState(false);
  const [nOo,setNOo]=useState({poNumber:"",vendor:"",partNo:"",lotNo:"",qtyOrdered:""});
  const [newPin,setNewPin]=useState("");

  const testConn=async()=>{
    if(!url.trim()){setToast({msg:"Enter URL first",type:"error"});return;}
    setTesting(true);
    try{
      const params = new URLSearchParams({action:"ping"});
      if(apiKey.trim()) params.set("apiKey", apiKey.trim());
      const r=await fetch(url.trim()+"?"+params.toString());
      const d=await r.json();
      if(d.success){setConfig(p=>({...p,appsScriptUrl:url.trim(),apiKey:apiKey.trim(),connected:true}));setToast({msg:"Connected: "+d.message,type:"success"});}
      else setToast({msg:"Failed: "+(d.error||"unknown"),type:"error"});
    }catch(err){setToast({msg:"Connection error: "+err.message,type:"error"});}
    setTesting(false);
  };

  const sectionStyle = {background:"var(--bg-card)",borderColor:"var(--border)"};

  return (<div className="p-4 space-y-5">
    <div className="flex items-center gap-2 mb-2"><GearIcon size={20} style={{color:"var(--text-muted)"}}/><h1 className="text-lg font-bold">Setup</h1></div>

    {/* FIX #12: Theme toggle + FIX #11: Scanner mode */}
    <section className="rounded-xl p-4 border" style={sectionStyle}>
      <h2 className="text-sm font-bold uppercase tracking-wider mb-3" style={{color:"var(--text-secondary)"}}>Display & Input</h2>
      <div className="flex gap-2">
        <button onClick={toggleTheme} className="flex-1 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border"
          style={{background: dark?"#1e293b":"#e2e8f0", color:"var(--text-primary)", borderColor:"var(--border)"}}>
          {dark?<MoonIcon size={16}/>:<SunIcon size={16}/>} {dark?"Dark Mode":"Light Mode"}
        </button>
        <button onClick={()=>{const v=!scannerMode;setScannerMode(v);lsSet("inv-scanner",v);setToast({msg:v?"Scanner mode ON ‚Äî keyboard hidden":"Scanner mode OFF",type:"info"});}}
          className={`flex-1 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border ${scannerMode?"bg-orange-600 text-white border-orange-500":"border"}`}
          style={!scannerMode?{background:"var(--input-bg)",color:"var(--text-primary)",borderColor:"var(--border)"}:{}}>
          <ScanIcon size={16}/> {scannerMode?"Scanner: ON":"Scanner: OFF"}
        </button>
      </div>
    </section>

    {admin&&<section className="rounded-xl p-4 border" style={sectionStyle}>
      <h2 className="text-sm font-bold uppercase tracking-wider mb-3" style={{color:"var(--text-secondary)"}}>Google Sheet Connection</h2>
      <ScanInput label="Apps Script URL" value={url} onChange={setUrl} placeholder="https://script.google.com/macros/s/.../exec"/>
      <ScanInput label="API Key (optional)" value={apiKey} onChange={setApiKey} placeholder="Shared secret for authentication"/>
      <div className="flex gap-2">
        <button onClick={()=>{setConfig(p=>({...p,appsScriptUrl:url.trim(),apiKey:apiKey.trim()}));setToast({msg:"Saved",type:"success"});}} className="flex-1 py-2.5 rounded-lg text-sm font-bold border" style={{background:"var(--input-bg)",color:"var(--text-primary)",borderColor:"var(--border)"}}>Save</button>
        <button onClick={testConn} disabled={testing} className="flex-1 py-2.5 bg-orange-600 hover:bg-orange-500 text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2">
          {testing?<RefreshIcon size={16} className="animate-spin"/>:<WifiIcon size={16}/>} Test</button>
        <button onClick={onSync} disabled={syncing} className="flex-1 py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2">
          {syncing?<RefreshIcon size={16} className="animate-spin"/>:<RefreshIcon size={16}/>} Sync</button>
      </div>
      {pendingCount>0&&<p className="text-xs text-amber-600 dark:text-amber-400 mt-2 font-bold">{pendingCount} pending transactions in offline queue</p>}
    </section>}

    {admin&&<section className="rounded-xl p-4 border" style={sectionStyle}>
      <h2 className="text-sm font-bold uppercase tracking-wider mb-3" style={{color:"var(--text-secondary)"}}>Register PO</h2>
      <button onClick={()=>setShowOo(!showOo)} className={`w-full py-2.5 rounded-lg text-sm font-bold ${showOo?"bg-amber-600 text-white":"border"}`}
        style={!showOo?{background:"var(--input-bg)",color:"var(--text-primary)",borderColor:"var(--border)"}:{}}>{showOo?"Cancel":"+ New PO"}</button>
      {showOo&&<div className="space-y-2 border-t pt-3 mt-3 slide-up" style={{borderColor:"var(--border)"}}>
        <ScanInput label="PO Number" value={nOo.poNumber} onChange={v=>setNOo(p=>({...p,poNumber:v}))} placeholder="AF12345"/>
        <ScanInput label="Vendor" value={nOo.vendor} onChange={v=>setNOo(p=>({...p,vendor:v}))} placeholder="Vendor"/>
        <ScanInput label="Part No" value={nOo.partNo} onChange={v=>setNOo(p=>({...p,partNo:v}))} placeholder="Part number"/>
        <ScanInput label="Lot No" value={nOo.lotNo} onChange={v=>setNOo(p=>({...p,lotNo:v}))} placeholder="LOT-2026-001"/>
        <NumInput label="Qty Ordered" value={nOo.qtyOrdered} onChange={v=>setNOo(p=>({...p,qtyOrdered:v}))}/>
        <button onClick={()=>{if(!nOo.poNumber||!nOo.partNo||!nOo.qtyOrdered)return;
          const id=genUUID("PLT-");
          const seq=barcodes.length+1;
          // BUG1: Only add order row if PO is new (multi-pallet: same PO, new QR)
          const existingPO=orders.find(o=>o.poNumber===nOo.poNumber);
          if(!existingPO) setOrders(p=>[...p,{...nOo,qtyOrdered:Number(nOo.qtyOrdered),qtyReceived:0,status:"AWAITING"}]);
          setBarcodes(p=>[...p,{barcodeId:id,seq,partNo:nOo.partNo,poNumber:nOo.poNumber,lotNo:nOo.lotNo,status:"AWAITING",qaStatus:"",qtyReceived:0,location:"",receivedDate:null,stockedDate:null,currentQty:0}]);
          postToSheet("register",{barcode:id,poNumber:nOo.poNumber,vendor:nOo.vendor,partNo:nOo.partNo,lotNo:nOo.lotNo,qtyOrdered:nOo.qtyOrdered});
          const pallets=barcodes.filter(b=>b.poNumber===nOo.poNumber).length+1;
          setNOo({poNumber:"",vendor:"",partNo:"",lotNo:"",qtyOrdered:""});setShowOo(false);
          setToast({msg:existingPO?`Pallet ${pallets} ‚Üí ${id} added to PO ${nOo.poNumber}`:`PO ${nOo.poNumber} ‚Üí QR ${id} registered`,type:"success"});}}
          className="w-full py-3 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-bold">REGISTER PO + QR CODE</button>
      </div>}
    </section>}

    {admin&&<section className="rounded-xl p-4 border" style={sectionStyle}>
      <h2 className="text-sm font-bold uppercase tracking-wider mb-3" style={{color:"var(--text-secondary)"}}>Data</h2>
      <div className="grid grid-cols-3 gap-3 text-center mb-4">
        <div><div className="text-2xl font-bold font-mono text-orange-600 dark:text-orange-400">{orders.length}</div><div className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Orders</div></div>
        <div><div className="text-2xl font-bold font-mono text-orange-600 dark:text-orange-400">{barcodes.length}</div><div className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>QR Codes</div></div>
        <div><div className="text-2xl font-bold font-mono text-emerald-600 dark:text-emerald-400">{lsGet("inv-txns")?.length||0}</div><div className="text-[10px] uppercase" style={{color:"var(--text-muted)"}}>Txns</div></div>
      </div>
      <div className="flex gap-2">
        <button onClick={()=>{setBarcodes(sampleBarcodes());setOrders(sampleOrders());setToast({msg:"Sample data loaded",type:"info"});}} className="flex-1 py-2.5 rounded-lg text-sm font-bold border" style={{background:"var(--input-bg)",color:"var(--text-primary)",borderColor:"var(--border)"}}>Load Samples</button>
        <button onClick={()=>{setTxns([]);setBarcodes([]);setOrders([]);setQueue([]);setDeadLetter([]);setToast({msg:"Cleared",type:"warning"});}} className="py-2.5 px-4 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm font-bold flex items-center gap-1"><TrashIcon size={14}/> Clear</button>
      </div>
    </section>}

    {admin&&(()=>{
      const dead = getDeadLetter();
      return dead.length > 0 ? (
        <section className="rounded-xl p-4 border border-red-300 dark:border-red-700" style={{background:"var(--bg-card)"}}>
          <h2 className="text-sm font-bold uppercase tracking-wider mb-3 flex items-center gap-2 text-red-600 dark:text-red-400"><AlertIcon size={14}/> Failed Transactions ({dead.length})</h2>
          <p className="text-xs mb-3" style={{color:"var(--text-muted)"}}>These items failed after {MAX_RETRIES} retries. Review, fix data, and retry or discard.</p>
          <div className="space-y-2 max-h-60 overflow-y-auto">
            {dead.map((d,i)=>(
              <div key={i} className="rounded-lg p-3 border text-xs" style={{background:"var(--input-bg)",borderColor:"var(--input-border)"}}>
                <div className="flex justify-between items-start mb-1">
                  <span className="font-bold" style={{color:"var(--text-primary)"}}>{d.form?.toUpperCase()}</span>
                  <span className="text-red-500 font-mono">{d._error?.slice(0,40)}</span>
                </div>
                <div style={{color:"var(--text-muted)"}}>
                  {d.data?.barcode&&<span>BC: {d.data.barcode} </span>}
                  {d.data?.partNo&&<span>Part: {d.data.partNo} </span>}
                  {d.data?.qty&&<span>Qty: {d.data.qty} </span>}
                </div>
                <div className="flex gap-2 mt-2">
                  <button onClick={()=>{pushQueue({form:d.form,data:d.data});const nd=[...dead];nd.splice(i,1);setDeadLetter(nd);setPendingCount(getQueue().length);setToast({msg:"Re-queued for retry",type:"info"});}}
                    className="text-xs py-1 px-3 rounded bg-orange-600 text-white font-bold">Retry</button>
                  <button onClick={()=>{const nd=[...dead];nd.splice(i,1);setDeadLetter(nd);setToast({msg:"Discarded",type:"warning"});}}
                    className="text-xs py-1 px-3 rounded bg-red-600 text-white font-bold">Discard</button>
                </div>
              </div>
            ))}
          </div>
          <button onClick={()=>{setDeadLetter([]);setToast({msg:"All failed items cleared",type:"warning"});}}
            className="w-full mt-3 py-2 text-xs font-bold rounded-lg bg-red-600 hover:bg-red-500 text-white">Clear All Failed</button>
        </section>
      ) : null;
    })()}

    {admin&&<section className="rounded-xl p-4 border" style={sectionStyle}>
      <h2 className="text-sm font-bold uppercase tracking-wider mb-3 flex items-center gap-2" style={{color:"var(--text-secondary)"}}><LockIcon size={14}/> Admin PIN</h2>
      <p className="text-xs mb-2" style={{color:"var(--text-muted)"}}>Current PIN: {(config.adminPin||"1234").replace(/./g,"‚Ä¢")} ‚Äî change below</p>
      <div className="flex gap-2">
        <input type="text" inputMode="numeric" maxLength={8} value={newPin} onChange={e=>setNewPin(e.target.value)} placeholder="New PIN"
          className="flex-1 py-2.5 px-4 rounded-lg border focus:border-orange-500 outline-none font-mono text-center text-lg tracking-widest"
          style={{background:"var(--input-bg)",color:"var(--text-primary)",borderColor:"var(--input-border)"}}/>
        <button onClick={()=>{if(newPin.length>=4){setConfig(p=>({...p,adminPin:newPin}));setNewPin("");setToast({msg:"PIN changed",type:"success"});}else setToast({msg:"PIN must be 4+ digits",type:"error"});}}
          className="py-2.5 px-6 bg-orange-600 hover:bg-orange-500 text-white rounded-lg text-sm font-bold">Save</button>
      </div>
    </section>}

    {!admin&&<section className="rounded-xl p-4 border" style={sectionStyle}>
      <div className="flex items-center gap-3" style={{color:"var(--text-muted)"}}>
        <LockIcon size={20}/>
        <div><p className="text-sm font-bold" style={{color:"var(--text-secondary)"}}>Admin features locked</p>
          <p className="text-xs">Tap the lock icon in the header to unlock with PIN</p></div>
      </div>
    </section>}
  </div>);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function App() {
  const [view,setView]=useState("dashboard");
  const [txns,setTxns]=useState([]);
  const [barcodes,setBarcodes]=useState([]);
  const [orders,setOrders]=useState([]);
  const [config,setConfig]=useState({appsScriptUrl:"",apiKey:"",connected:false});
  const [loading,setLoading]=useState(true);
  const [toast,setToast]=useState(null);
  const [syncing,setSyncing]=useState(false);
  const [admin,setAdmin]=useState(false);
  const [showPin,setShowPin]=useState(false);
  const [pin,setPin]=useState("");
  const [scannerMode,setScannerMode]=useState(false);
  const [pendingCount,setPendingCount]=useState(0);

  const {dark, toggle: toggleTheme} = useTheme();
  const online = useOnline();

  // Load state
  useEffect(()=>{
    setTxns(lsGet("inv-txns")||[]);
    setBarcodes(lsGet("inv-barcodes")||sampleBarcodes());
    setOrders(lsGet("inv-orders")||sampleOrders());
    setConfig(lsGet("inv-config")||{appsScriptUrl:"",apiKey:"",connected:false,adminPin:"1234"});
    setAdmin(!!lsGet("inv-admin"));
    setScannerMode(!!lsGet("inv-scanner"));
    setPendingCount(getQueue().length);
    setLoading(false);

    // QR deep link: if URL has ?barcode=PLT-XXXXX, auto-switch to receiving
    const params = new URLSearchParams(window.location.search);
    const qrBarcode = params.get("barcode");
    if (qrBarcode) {
      setView("receiving");
      // Store barcode for form to pick up
      window._qrPrefill = {
        barcode: qrBarcode,
        partNo: params.get("part") || "",
        poNumber: params.get("po") || "",
        lotNo: params.get("lot") || "",
      };
      // Clean URL so refresh doesn't re-trigger
      window.history.replaceState({}, "", window.location.pathname);
    }
  },[]);

  // Persist state
  useEffect(()=>{if(!loading)lsSet("inv-txns",txns);},[txns,loading]);
  useEffect(()=>{if(!loading)lsSet("inv-barcodes",barcodes);},[barcodes,loading]);
  useEffect(()=>{if(!loading)lsSet("inv-orders",orders);},[orders,loading]);
  useEffect(()=>{if(!loading)lsSet("inv-config",config);},[config,loading]);
  useEffect(()=>{if(!loading)lsSet("inv-admin",admin?true:null);},[admin,loading]);

  // ‚ïê‚ïê‚ïê POST to Apps Script (queues on failure) ‚ïê‚ïê‚ïê
  const postToSheet=useCallback(async(form,data)=>{
    if(!config.appsScriptUrl) return false;
    try{
      await sendToGAS(config.appsScriptUrl, form, data, config.apiKey);
      return true;
    } catch(e) {
      console.warn("Sheet post failed, queuing:", e.message);
      pushQueue({ form, data });
      setPendingCount(getQueue().length);
      return false;
    }
  },[config.appsScriptUrl, config.apiKey]);

  // ‚ïê‚ïê‚ïê Background queue flush (OPT1: uses sendToGAS, OPT5: tracks dead count per cycle) ‚ïê‚ïê‚ïê
  useEffect(()=>{
    if(loading) return;
    const flush = async () => {
      if(!config.appsScriptUrl || !navigator.onLine) return;
      const q = getQueue();
      if(q.length === 0) return;

      const remaining = [];
      let deadThisCycle = 0;
      for(const item of q) {
        try {
          await sendToGAS(config.appsScriptUrl, item.form, item.data, config.apiKey);
        } catch(e) {
          item._retries = (item._retries || 0) + 1;
          if(item._retries < MAX_RETRIES) {
            remaining.push(item);
          } else {
            moveToDead(item, e.message);
            deadThisCycle++;
          }
        }
      }
      setQueue(remaining);
      setPendingCount(remaining.length);
      const uploaded = q.length - remaining.length - deadThisCycle;
      if(uploaded > 0) {
        setToast({msg:`Uploaded ${uploaded} pending transaction(s)${deadThisCycle > 0 ? ` ¬∑ ${deadThisCycle} failed` : ""}`,type: deadThisCycle > 0 ? "warning" : "success"});
      } else if(deadThisCycle > 0) {
        setToast({msg:`${deadThisCycle} item(s) moved to Failed ‚Äî review in Settings`,type:"error"});
      }
    };
    const iv = setInterval(flush, 30000);
    flush();
    return () => clearInterval(iv);
  },[loading, config.appsScriptUrl, config.apiKey]);

  // ‚ïê‚ïê‚ïê Sync: flush queue then pull server state (OPT1: sendToGAS, BUG4: replace txns) ‚ïê‚ïê‚ïê
  const onSync=useCallback(async()=>{
    if(!config.appsScriptUrl){setToast({msg:"No URL configured",type:"error"});return;}

    setSyncing(true);

    // Step 1: Flush pending queue
    const q = getQueue();
    if(q.length > 0) {
      setToast({msg:`Uploading ${q.length} pending...`,type:"info"});
      const remaining = [];
      for(const item of q) {
        try {
          await sendToGAS(config.appsScriptUrl, item.form, item.data, config.apiKey);
        } catch(e) {
          item._retries = (item._retries || 0) + 1;
          if(item._retries < MAX_RETRIES) {
            remaining.push(item);
          } else {
            moveToDead(item, e.message);
          }
        }
      }
      setQueue(remaining);
      setPendingCount(remaining.length);
      if(remaining.length > 0) {
        setToast({msg:`${remaining.length} still pending ‚Äî sync aborted`,type:"warning"});
        setSyncing(false);
        return;
      }
    }

    // Step 2: Pull server state
    try{
      const params = new URLSearchParams({action:"sync"});
      if(config.apiKey) params.set("apiKey", config.apiKey);
      const r=await fetch(config.appsScriptUrl+"?"+params.toString());
      const d=await r.json();
      if(d.success){
        // Orders: server wins for known POs, keep local-only
        if(d.openOrders?.length) {
          setOrders(prev => {
            const serverPOs = new Set(d.openOrders.map(o => o.poNumber));
            const localOnly = prev.filter(o => !serverPOs.has(o.poNumber));
            return [...d.openOrders, ...localOnly];
          });
        }
        // Barcodes: server wins for known IDs, keep local-only
        if(d.barcodes?.length) {
          setBarcodes(prev => {
            const serverBCs = new Set(d.barcodes.map(b => b.barcodeId));
            const localOnly = prev.filter(b => !serverBCs.has(b.barcodeId));
            return [...d.barcodes, ...localOnly];
          });
        }
        // BUG4 FIX: Txns ‚Äî server is source of truth, replace entirely.
        // Local optimistic txns use different ID format than server, so merge
        // by txnId never works. Since queue is flushed above, all local txns
        // that succeeded are now on the server. Just take server state.
        if(d.transactions?.length) {
          setTxns(d.transactions.map(t => ({
            id: t.txnId, txnId: t.txnId, source: t.source, timestamp: t.timestamp,
            type: t.type, barcode: t.barcode, partNo: t.partNo, qty: t.qty,
            location: t.location, reference: t.reference, operator: t.operator,
            qaStatus: t.qaStatus, notes: t.notes,
          })));
        }
        setToast({msg:`Synced: ${d.openOrders?.length||0} orders, ${d.barcodes?.length||0} QR codes, ${d.transactions?.length||0} txns`,type:"success"});
      } else setToast({msg:"Sync failed: "+(d.error||"unknown"),type:"error"});
    }catch(err){setToast({msg:"Connection failed: "+err.message,type:"error"});}
    setSyncing(false);
  },[config.appsScriptUrl, config.apiKey]);

  // ‚ïê‚ïê‚ïê SUBMIT HANDLERS ‚ïê‚ïê‚ïê
  const submitReceiving=useCallback(data=>{
    const txn={id:genUUID("TXN-"),source:"RECEIVING",timestamp:new Date().toISOString(),type:"IN",barcode:data.barcode,partNo:data.partNo,qty:Number(data.qty),location:"DOCK",reference:data.poNumber,operator:data.inspector,qaStatus:data.qaStatus,notes:data.notes};
    setTxns(p=>[...p,txn]);
    setBarcodes(p=>p.map(b=>b.barcodeId===data.barcode?{...b,status:"RECEIVED",qaStatus:data.qaStatus,qtyReceived:Number(data.qty),receivedDate:txn.timestamp,currentQty:Number(data.qty)}:b));
    setOrders(p=>p.map(o=>o.poNumber===data.poNumber?{...o,qtyReceived:(o.qtyReceived||0)+Number(data.qty),status:((o.qtyReceived||0)+Number(data.qty))>=o.qtyOrdered?"COMPLETE":"PARTIAL"}:o));
    postToSheet("receiving",data);
    setToast({msg:`‚úì Received ${data.qty} √ó ${data.partNo}`,type:"success"});
  },[postToSheet]);

  const submitStockroom=useCallback(data=>{
    const bc=barcodes.find(b=>b.barcodeId===data.barcode);
    const txn={id:genUUID("TXN-"),source:"STOCKROOM",timestamp:new Date().toISOString(),type:"LOCATION",barcode:data.barcode,partNo:data.partNo||bc?.partNo||"",qty:0,location:data.location,reference:"",operator:data.operator,qaStatus:"",notes:data.notes};
    setTxns(p=>[...p,txn]);
    setBarcodes(p=>p.map(b=>b.barcodeId===data.barcode?{...b,status:"IN STOCK",location:data.location,stockedDate:txn.timestamp}:b));
    postToSheet("stockroom",{...data, partNo: data.partNo||bc?.partNo||""});
    setToast({msg:`‚úì ${data.barcode} ‚Üí ${data.location}`,type:"success"});
  },[barcodes,postToSheet]);

  const submitIssuing=useCallback(data=>{
    const bc=barcodes.find(b=>b.barcodeId===data.barcode);
    const txn={id:genUUID("TXN-"),source:"PRODUCTION",timestamp:new Date().toISOString(),type:"OUT",barcode:data.barcode,partNo:data.partNo||bc?.partNo||"",qty:-Math.abs(Number(data.qty)),location:"",reference:data.woNumber,operator:data.operator,qaStatus:"",notes:data.notes};
    setTxns(p=>[...p,txn]);
    const nq=(bc?.currentQty||0)-Math.abs(Number(data.qty));
    setBarcodes(p=>p.map(b=>b.barcodeId===data.barcode?{...b,currentQty:nq,status:nq<=0?"DEPLETED":"IN STOCK"}:b));
    postToSheet("production",{...data, partNo: data.partNo||bc?.partNo||""});
    setToast({msg:`‚úì Issued ${data.qty} to ${data.woNumber}`,type:"success"});
  },[barcodes,postToSheet]);

  // Derived
  const queue=barcodes.filter(b=>b.status==="RECEIVED").map(b=>({...b,hrsStaging:timeSince(b.receivedDate),prio:prio(timeSince(b.receivedDate))})).sort((a,b)=>(b.hrsStaging||0)-(a.hrsStaging||0));
  const awaiting=orders.filter(o=>o.status==="AWAITING").length;
  const inStock=barcodes.filter(b=>b.status==="IN STOCK").length;
  const depleted=barcodes.filter(b=>b.status==="DEPLETED").length;
  const urgentCount=queue.filter(q=>q.prio.label==="URGENT").length;

  // OPT4: memoize so issuing/inventory views don't recompute on unrelated state changes
  const inventoryByPart=useMemo(()=>{
    const map={};
    barcodes.filter(b=>b.status==="IN STOCK"||b.status==="RECEIVED").forEach(b=>{
      if(!map[b.partNo])map[b.partNo]={partNo:b.partNo,totalQty:0,barcodes:[],locations:new Set()};
      map[b.partNo].totalQty+=(b.currentQty||0);
      map[b.partNo].barcodes.push(b);
      if(b.location)map[b.partNo].locations.add(b.location);
    });
    return map;
  },[barcodes]);

  const verifyPin=()=>{
    if(pin===(config.adminPin||"1234")){setAdmin(true);setShowPin(false);setPin("");setToast({msg:"Admin unlocked",type:"success"});}
    else{setPin("");setToast({msg:"Wrong PIN",type:"error"});}
  };
  const lockOut=()=>{setAdmin(false);lsSet("inv-admin",null);if(view==="inventory")setView("dashboard");setToast({msg:"Locked",type:"info"});};

  if(loading)return <div className="min-h-screen flex items-center justify-center" style={{background:"var(--bg-primary)"}}><RefreshIcon size={48} className="animate-spin text-orange-500"/></div>;

  const tabs=[
    {id:"dashboard",label:"Dash",Ic:ChartIcon,badge:urgentCount>0?urgentCount:null},
    {id:"receiving",label:"Receive",Ic:ClipboardIcon},
    {id:"stockroom",label:"Stock",Ic:WarehouseIcon,badge:queue.length>0?queue.length:null},
    {id:"issuing",label:"Issue",Ic:ArrowsIcon},
    ...(admin?[{id:"inventory",label:"Inventory",Ic:PackageIcon}]:[]),
    {id:"settings",label:"Setup",Ic:GearIcon,badge:pendingCount>0?pendingCount:null},
  ];

  return (<div className="min-h-screen flex flex-col font-sans" style={{background:"var(--bg-primary)",color:"var(--text-primary)"}}>
    {toast&&<Toast msg={toast.msg} type={toast.type} onClose={()=>setToast(null)}/>}

    {showPin&&<div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" onClick={()=>{setShowPin(false);setPin("");}}>
      <div className="rounded-2xl p-6 w-full max-w-xs border" style={{background:"var(--bg-card)",borderColor:"var(--border)"}} onClick={e=>e.stopPropagation()}>
        <div className="text-center mb-4"><LockIcon size={32} className="mx-auto text-orange-500 mb-2"/><h2 className="font-bold text-lg">Admin PIN</h2>
          <p className="text-xs mt-1" style={{color:"var(--text-muted)"}}>Default: 1234 ‚Äî change in Setup</p></div>
        <input type="password" inputMode="numeric" maxLength={8} value={pin} onChange={e=>setPin(e.target.value)}
          onKeyDown={e=>{if(e.key==="Enter")verifyPin();}}
          autoFocus className="w-full py-4 px-4 rounded-xl text-3xl font-mono text-center tracking-[0.5em] border-2 focus:border-orange-500 outline-none"
          style={{background:"var(--input-bg)",color:"var(--text-primary)",borderColor:"var(--input-border)"}}/>
        <button onClick={verifyPin} className="w-full py-3 mt-4 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold text-lg">UNLOCK</button>
        <button onClick={()=>{setShowPin(false);setPin("");}} className="w-full py-2 mt-2 text-sm" style={{color:"var(--text-muted)"}}>Cancel</button>
      </div>
    </div>}

    <header className="border-b px-4 py-3 flex items-center justify-between shrink-0" style={{background:"var(--header-bg)",borderColor:"var(--border)"}}>
      <div className="flex items-center gap-2"><div className="w-8 h-8 rounded-lg bg-orange-600 flex items-center justify-center text-white"><PackageIcon size={18}/></div>
        <span className="font-bold text-sm tracking-wide">INVENTORY</span></div>
      <div className="flex items-center gap-3">
        {!online&&<span className="text-xs font-bold text-red-500 bg-red-50 dark:bg-red-950 px-2 py-1 rounded border border-red-300 dark:border-red-700">OFFLINE</span>}
        {pendingCount>0&&<span className="text-xs font-bold text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-950 px-2 py-1 rounded border border-amber-300 dark:border-amber-700">{pendingCount}‚Üë</span>}
        {online&&config.appsScriptUrl?<WifiIcon size={16} className="text-emerald-500"/>:<WifiOffIcon size={16} style={{color:"var(--text-muted)"}}/>}
        <button onClick={()=>{if(admin)lockOut();else setShowPin(true);}} className={`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold transition-all border ${admin?"bg-orange-50 dark:bg-orange-900 text-orange-600 dark:text-orange-400 border-orange-300 dark:border-orange-700":""}`}
          style={!admin?{background:"var(--input-bg)",color:"var(--text-muted)",borderColor:"var(--border)"}:{}}>
          {admin?<><UnlockIcon size={14}/> Admin</>:<><LockIcon size={14}/> Lock</>}
        </button>
      </div>
    </header>
    <main className="flex-1 overflow-y-auto pb-20">
      {view==="dashboard"&&<DashboardView txns={txns} queue={queue} awaiting={awaiting} inStock={inStock} depleted={depleted} urgentCount={urgentCount} barcodes={barcodes} admin={admin} pendingCount={pendingCount}/>}
      {view==="receiving"&&<ReceivingForm barcodes={barcodes} orders={orders} onSubmit={submitReceiving} scannerMode={scannerMode}/>}
      {view==="stockroom"&&<StockroomForm queue={queue} barcodes={barcodes} onSubmit={submitStockroom} scannerMode={scannerMode}/>}
      {view==="issuing"&&<IssuingForm barcodes={barcodes} inventoryByPart={inventoryByPart} onSubmit={submitIssuing} scannerMode={scannerMode}/>}
      {view==="inventory"&&<InventoryView inventoryByPart={inventoryByPart} barcodes={barcodes}/>}
      {view==="settings"&&<SettingsView config={config} setConfig={setConfig} onSync={onSync} syncing={syncing} setToast={setToast} setBarcodes={setBarcodes} setOrders={setOrders} setTxns={setTxns} orders={orders} barcodes={barcodes} admin={admin} dark={dark} toggleTheme={toggleTheme} scannerMode={scannerMode} setScannerMode={setScannerMode} pendingCount={pendingCount} postToSheet={postToSheet}/>}
    </main>
    <nav className="fixed bottom-0 left-0 right-0 border-t flex justify-around py-1 z-40" style={{background:"var(--nav-bg)",borderColor:"var(--border)"}}>
      {tabs.map(t=>(<button key={t.id} onClick={()=>setView(t.id)}
        className={`flex flex-col items-center py-1.5 px-2 rounded-lg transition-all relative ${view===t.id?"text-orange-500":""}`}
        style={view!==t.id?{color:"var(--text-muted)"}:{}}>
        <t.Ic size={20}/><span className="text-[10px] mt-0.5 font-medium">{t.label}</span>
        {t.badge&&<span className="absolute -top-0.5 right-0 min-w-[18px] h-[18px] rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center px-1">{t.badge}</span>}
      </button>))}
    </nav>
  </div>);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
